name: Manual Update & Build

on:
  workflow_dispatch:
    inputs:
      skip_validation:
        description: 'Skip validation (not recommended)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  update-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # Step 1: Update game data (with validation)
      - name: Update game data
        run: node scripts/update-data.js

      # Step 2: Cleanup orphaned game HTML pages
      - name: Cleanup orphaned game pages
        run: node scripts/cleanup-orphaned-pages.js

      # Step 3: Validate games (unless skipped)
      - name: Validate games
        if: inputs.skip_validation != 'true'
        run: npm run validate

      # Step 4: Build site
      - name: Build site
        run: npm run build

      # Step 5: Copy files to dist
      - name: Copy game, data, asset folders, and static files
        run: |
          mkdir -p dist
          cp -r games dist/games
          cp -r assets dist/assets
          cp -r important-pages dist/important-pages

          # Use rsync so dist/data matches repo/data exactly (deletes removed files)
          rsync -av --delete data/ dist/data/

          # Copy news JSON source files
          if [ -d news ]; then cp -r news dist/news; fi

          # Copy static files (includes news.html and news-*.html generated by build)
          cp index.html dist/index.html
          cp *.html dist/
          # Only copy ads.txt if it exists (may be absent when ads are disabled)
          if [ -f ads.txt ]; then cp ads.txt dist/ads.txt; fi
          cp sitemap.xml dist/sitemap.xml
          cp robots.txt dist/robots.txt
          cp google0d95473435a7c986.html dist/google0d95473435a7c986.html
          cp .nojekyll dist/.nojekyll

      # Step 6: Commit data changes (if any)
      - name: Commit data changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Stage all files that the build may produce or modify
          git add -A data/
          git add -A news/ 2>/dev/null || true
          git add -A "*.html" 2>/dev/null || true
          git add news.html 2>/dev/null || true
          git add sitemap.xml robots.txt 2>/dev/null || true
          git add ads-config.json 2>/dev/null || true
          if [ -f ads.txt ]; then git add ads.txt; else git rm --cached ads.txt 2>/dev/null || true; fi

          # Only commit if there is actually something staged
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update game data and rebuild site" --author="github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

            # Push with retry logic
            MAX_RETRIES=5
            RETRY_COUNT=0
            DELAY=2

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Attempting to push (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."

              if git push origin main; then
                echo "Successfully pushed changes"
                break
              else
                echo "Push failed, pulling with rebase..."
                if git pull --rebase origin main; then
                  echo "Rebase successful, retrying push..."
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  sleep $DELAY
                  DELAY=$((DELAY * 2))
                else
                  echo "Rebase failed, aborting..."
                  git rebase --abort
                  exit 1
                fi
              fi
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "Failed to push after $MAX_RETRIES attempts"
              exit 1
            fi
          fi

      # Step 7: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          clean: false

      - name: Summary
        run: |
          echo "âœ¨ Update and build completed successfully!"
          echo "ðŸ“Š Summary:"
          echo "   - Updated game data JSON files"
          echo "   - Cleaned up orphaned game pages"
          echo "   - Validated all games"
          echo "   - Built and deployed to GitHub Pages"
