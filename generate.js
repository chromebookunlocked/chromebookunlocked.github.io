const fs = require("fs");
const path = require("path");

const dataDir = path.join(__dirname, "data");
const gamesDir = path.join(__dirname, "games");
const outputDir = path.join(__dirname, "dist");
const outputFile = path.join(outputDir, "index.html");

if (!fs.existsSync(outputDir)) fs.mkdirSync(outputDir);

// Load games
let games = fs.readdirSync(dataDir)
  .filter(f => f.endsWith(".json"))
  .map(f => {
    const json = JSON.parse(fs.readFileSync(path.join(dataDir, f)));
    // Support multiple categories (comma-separated string or array)
    let gameCategories = json.category || json.categories || "Uncategorized";
    if (typeof gameCategories === 'string') {
      gameCategories = gameCategories.split(',').map(c => c.trim());
    }
    if (!Array.isArray(gameCategories)) {
      gameCategories = [gameCategories];
    }
    
    return {
      folder: json.folder || f.replace(".json", ""),
      name: json.name || f.replace(".json", ""),
      categories: gameCategories, // Array of categories
      thumbs: json.thumbs && json.thumbs.length ? json.thumbs : ["thumbnail.png", "thumbnail.jpg"],
      dateAdded: json.dateAdded || null // Support for "Newly Added" sorting
    };
  });

// Filter out games that do not have a folder or a playable index.html
games = games.filter(g => {
  const folderPath = path.join(gamesDir, g.folder);
  const indexPath = path.join(folderPath, "index.html");
  return fs.existsSync(folderPath) && fs.existsSync(indexPath);
});

// Group into categories (games can appear in multiple categories)
const categories = {};
games.forEach(g => {
  g.categories.forEach(cat => {
    if (!categories[cat]) categories[cat] = [];
    categories[cat].push(g);
  });
});

// Add "Newly Added" category if games have dateAdded
const gamesWithDates = games.filter(g => g.dateAdded).sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
if (gamesWithDates.length > 0) {
  categories['Newly Added'] = gamesWithDates.slice(0, 20); // Show latest 20 games
}

// Utility to find the actual thumb file (existing)
function chooseThumb(game) {
  const thumb = game.thumbs.find(t => fs.existsSync(path.join(gamesDir, game.folder, t)));
  return thumb || game.thumbs[0];
}

// Generate game card string with data-index for JS control
function generateGameCard(game, idx) {
  const thumb = chooseThumb(game);
  const thumbUrl = `games/${game.folder}/${thumb}`;
  return `<div class=\"card game-card\" data-index=\"${idx}\" data-folder=\"${game.folder}\" data-name=\"${game.name.toLowerCase()}\" onclick=\"prepareGame('${encodeURIComponent(game.folder)}','${encodeURIComponent(game.name)}','${thumbUrl}')\">
    <div class=\"thumb-container\" style=\"--thumb-url: url('${thumbUrl}')\">
      <img class=\"thumb\" src=\"${thumbUrl}\" alt=\"${game.name}\">
    </div>
    <div class=\"card-title\">${game.name}</div>
  </div>`;
}

// Sidebar categories - exclude "Newly Added" and "Recently Played"
const sidebarCategories = Object.keys(categories)
  .filter(cat => cat !== "Recently Played" && cat !== "Newly Added")
  .map(cat => `<li onclick=\"filterCategory('${cat}')\">${cat}</li>\n`)
  .join("");

// Add "Newly Added" at the top if it exists
const newlyAddedItem = categories['Newly Added'] ? 
  `<li onclick=\"filterCategory('Newly Added')\" style=\"border-bottom: 1px solid rgba(255,102,255,0.3); padding-bottom: 0.8rem; margin-bottom: 0.8rem;\">‚ú® Newly Added</li>` : ''; 

// Add "All Games" after Home
const allGamesItem = `<li onclick=\"filterCategory('All Games')\">All Games</li>`;

const finalSidebarCategories = newlyAddedItem + allGamesItem + sidebarCategories;

// Full HTML template
const html = `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  \n  <!-- Primary Meta Tags -->\n  <title>Chromebook Unlocked Games - Free Unblocked Games for School</title>\n  <meta name=\"title\" content=\"Chromebook Unlocked Games - Free Unblocked Games for School\">\n  <meta name=\"description\" content=\"Play free unblocked games at school on your Chromebook. Access 100+ unlocked online games that work on school computers. No downloads required - play instantly.\">\n  <meta name=\"keywords\" content=\"chromebook unlocked games, unblocked games, free online games, school games, chromebook games, unblocked games at school, online games unblocked, school computer games\">\n  <meta name=\"robots\" content=\"index, follow\">\n  <meta name=\"language\" content=\"English\">\n  <meta name=\"author\" content=\"Chromebook Unlocked Games\">\n  \n  <!-- Open Graph / Facebook -->\n  <meta property=\"og:type\" content=\"website\">\n  <meta property=\"og:url\" content=\"https://chromebookunlocked.github.io/\">\n  <meta property=\"og:title\" content=\"Chromebook Unlocked Games - Free Unblocked Games for School\">\n  <meta property=\"og:description\" content=\"Play free unblocked games at school on your Chromebook. Access 100+ unlocked online games that work on school computers. No downloads required!\">\n  <meta property=\"og:image\" content=\"https://chromebookunlocked.github.io/assets/logo.png\">\n  <meta property=\"og:site_name\" content=\"Chromebook Unlocked Games\">\n  \n  <!-- Twitter -->\n  <meta property=\"twitter:card\" content=\"summary_large_image\">\n  <meta property=\"twitter:url\" content=\"https://chromebookunlocked.github.io/\">\n  <meta property=\"twitter:title\" content=\"Chromebook Unlocked Games - Free Unblocked Games for School\">\n  <meta property=\"twitter:description\" content=\"Play free unblocked games at school on your Chromebook. Access 100+ unlocked online games that work on school computers. No downloads required!\">\n  <meta property=\"twitter:image\" content=\"https://chromebookunlocked.github.io/assets/logo.png\">\n  \n  <!-- Favicon -->\n  <link rel=\"icon\" type=\"image/png\" href=\"assets/logo.png\">\n  <link rel=\"apple-touch-icon\" href=\"assets/logo.png\">\n  <link rel=\"shortcut icon\" type=\"image/png\" href=\"assets/logo.png\">\n  \n  <!-- Additional SEO -->\n  <meta name=\"theme-color\" content=\"#ff66ff\">\n  <link rel=\"canonical\" href=\"https://chromebookunlocked.github.io/\">\n  \n  <!-- Structured Data for Search Engines -->\n  <script type=\"application/ld+json\">\n  {\n    \"@context\": \"https://schema.org\",\n    \"@type\": \"WebSite\",\n    \"name\": \"Chromebook Unlocked Games\",\n    \"url\": \"https://chromebookunlocked.github.io/\",\n    \"description\": \"Play free unblocked games at school on your Chromebook. Access 100+ unlocked online games that work on school computers.\",\n    \"image\": \"https://chromebookunlocked.github.io/assets/logo.png\",\n    \"publisher\": {\n      \"@type\": \"Organization\",\n      \"name\": \"Chromebook Unlocked Games\",\n      \"logo\": {\n        \"@type\": \"ImageObject\",\n        \"url\": \"https://chromebookunlocked.github.io/assets/logo.png\"\n      }\n    }\n  }\n  </script>\n  \n  <style>\n    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');\n    :root {\n      --base-font: clamp(12px, 1.2vw, 18px);\n      --sidebar-width: clamp(45px, 5vw, 70px);\n      --accent: #ff66ff;\n      --accent-dark: #cc33ff;\n      --accent-light: #ff99ff;\n      --background-dark: #1c0033;\n      --card-bg: #4d0066;\n      --card-hover: #660099;\n      --font-main: 'Orbitron', sans-serif;\n      --content-max-width: 1400px;\n      --grid-gap: clamp(0.8rem, 1.5vw, 1.2rem);\n    }\n    \n    * { box-sizing: border-box; }\n    html,body { margin:0; padding:0; height:100%; background: linear-gradient(135deg, #0d001a 0%, #1c0033 50%, #2d0052 100%); font-family:var(--font-main); color:#eee; font-size:var(--base-font); overflow:hidden; }\n    \n    #sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, #330066 0%, #1a0033 100%); padding:0; height:100vh; overflow:hidden; position:fixed; left:0; top:0; z-index:1000; transition: width .3s ease; border-right: 2px solid rgba(255, 102, 255, 0.2); box-shadow: 5px 0 20px rgba(255, 102, 255, 0.1); }\n    #sidebar:hover { width:250px; box-shadow: 5px 0 30px rgba(255, 102, 255, 0.3); }\n\n    #sidebar header { position: sticky; top: 0; display:flex; align-items:center; justify-content:center; height: 90px; padding: 1rem 0; background: linear-gradient(180deg, #330066 0%, #1a0033 100%); z-index: 1; cursor: pointer; }\n    #sidebar header img { height:60px; width:auto; filter: drop-shadow(0 0 10px var(--accent)); transition: transform .3s ease; }\n    #sidebar:hover header img { transform: scale(1.1); }\n\n    #sidebarIndicator { position: absolute; right: 2px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; opacity: 0.5; pointer-events: none; font-size: 1.5rem; color: rgba(255, 255, 255, 0.7); }\n    #sidebarIndicator::before { content: '‚Ä∫'; font-weight: 300; transition: transform .3s ease; }\n    #sidebar:hover #sidebarIndicator::before { transform: rotate(180deg); }\n\n    #sidebarScroll { position: absolute; top: 90px; bottom: 0; left: 0; right: 0; overflow-y: auto; overflow-x: hidden; padding: 1rem 0; scrollbar-width: none; }\n    #sidebarScroll::-webkit-scrollbar { width: 0; display: none; }\n\n    #sidebar ul { list-style:none; padding:0; margin:0; }\n    #sidebar li { cursor:pointer; padding:.7rem 1rem; margin: 0.5rem; border-radius:8px; transition:.3s ease; white-space:nowrap; font-family:var(--font-main); font-weight: 600; border: 1px solid transparent; }\n    #sidebar li:hover { background: linear-gradient(135deg, #660099, #7700aa); border: 1px solid var(--accent); box-shadow:0 0 15px var(--accent); color:#fff; transform: translateX(5px); }\n    \n    #content { padding:0; overflow-y:auto; overflow-x:hidden; margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); transition: margin-left .3s; height:100vh; -webkit-overflow-scrolling: touch; }\n    \n    #topHeader { background: linear-gradient(135deg, #330066 0%, #1c0033 100%); padding: clamp(1rem, 2vw, 1.5rem) clamp(1rem, 3vw, 2rem); border-bottom: 2px solid rgba(255, 102, 255, 0.3); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; gap: clamp(0.5rem, 1.5vw, 1rem); flex-wrap: nowrap; }\n\n    #topHeader h1 { margin: 0; font-size: clamp(1.1rem, 2.2vw, 2.2rem); font-weight: 900; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; white-space: nowrap; cursor: pointer; transition: transform .3s ease; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0; }\n    #topHeader h1:hover { transform: scale(1.05); }\n\n    #rightHeaderGroup { display: flex; align-items: center; justify-content: flex-end; gap: 0.1rem; margin-left: auto; }\n    #bookmarkBtn { order: 1; padding: 0.6rem 1rem; background: linear-gradient(135deg, rgba(255, 102, 255, 0.2), rgba(204, 51, 255, 0.2)); border: 1px solid rgba(255, 102, 255, 0.4); border-radius: 10px; cursor: pointer; font-size: 1.2rem; color: var(--accent-light); transition: all .3s ease; display: flex; align-items: center; justify-content: center; min-width: 40px; height: 40px; flex-shrink: 0; }\n    #bookmarkBtn:hover { background: linear-gradient(135deg, rgba(255, 102, 255, 0.4), rgba(204, 51, 255, 0.4)); border-color: var(--accent); transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 102, 255, 0.5); }\n    #bookmarkBtn:active { transform: scale(0.95); }\n\n    #searchContainer { order: 2; flex: 0 1 350px; max-width: 500px; min-width: 200px; position: relative; }\n    #searchIcon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, 0.5); pointer-events: none; font-size: 1.1rem; }\n    #searchBar { width: 100%; padding: 0.8rem 1.2rem 0.8rem 3rem; border: 2px solid rgba(255, 102, 255, 0.3); border-radius: 25px; background: rgba(0, 0, 0, 0.4); color: #fff; font-family: var(--font-main); font-size: 1rem; outline: none; transition: all .3s ease; }\n    #searchBar::placeholder { color: rgba(255, 255, 255, 0.5); }\n    #searchBar:focus { border-color: var(--accent); box-shadow: 0 0 20px rgba(255, 102, 255, 0.4); background: rgba(0, 0, 0, 0.6); }\n\n    /* Search dropdown: isolated, small, non-intrusive */\n    #searchDropdown { position: absolute; top: calc(100% + 6px); left: 0; right: 0; display: none; z-index: 1000; background: rgba(0,0,0,0.55); backdrop-filter: blur(6px); border: 1px solid rgba(255, 102, 255, 0.3); border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.35); max-height: 320px; overflow: auto; padding: 4px; box-sizing: border-box; }\n    #searchDropdown.show { display: block; }\n    #searchDropdown .search-result-item { display: flex; width: 100%; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; background: transparent; border: none; border-radius: 8px; text-align: left; outline: none; }\n    #searchDropdown .search-result-item:hover { background: rgba(255, 102, 255, 0.15); }\n    #searchDropdown .search-result-thumb { width: 40px !important; height: 40px !important; object-fit: cover; border-radius: 8px; flex: 0 0 40px; display: block; }\n    #searchDropdown .search-result-name { color: #fff; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n    @media (max-width: 380px) { #searchDropdown .search-result-thumb { width: 36px !important; height: 36px !important; flex-basis: 36px; } }\n\n    /* Controls */\n    #controls { display:none; justify-content:space-between; align-items:center; max-width:1400px; margin:0 auto 1rem auto; padding:.5rem; font-size:1.1em; }\n    #controls.active { display: flex; }\n    button { padding:.7rem 1.3rem; border:none; border-radius:12px; cursor:pointer; font-size:1em; background:linear-gradient(135deg,var(--accent),var(--accent-dark)); color:#fff; font-weight:700; letter-spacing:.5px; transition:all .3s ease; box-shadow:0 4px 15px rgba(255, 102, 255, 0.3); font-family:var(--font-main); border: 1px solid rgba(255, 102, 255, 0.4); }\n    button:hover { transform:translateY(-2px) scale(1.05); box-shadow:0 6px 25px rgba(255, 102, 255, 0.5); }\n    button:active { transform:translateY(0) scale(1); }\n    #backBtn { background:linear-gradient(135deg,#ff99ff,var(--accent)); }\n    #fullscreenBtn { background:linear-gradient(135deg,var(--accent-dark),#9933ff); }\n    \n    /* Viewer */\n    .viewer { position:relative; display:none; justify-content:center; align-items:center; width:100%; max-width: 1400px; aspect-ratio:16 / 9; background:transparent; border-radius:15px; overflow:hidden; margin:0 auto 2rem auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); transition: all 0.3s ease; }\n    .viewer:fullscreen, .viewer:-webkit-full-screen, .viewer:-moz-full-screen, .viewer:-ms-fullscreen { max-width: 100vw; width: 100vw; height: 100vh; aspect-ratio: auto; border-radius: 0; margin: 0; }\n    .viewer iframe { width:100%; height:100%; border:none; background:transparent; loading:lazy; }\n    .viewer:fullscreen iframe, .viewer:-webkit-full-screen iframe, .viewer:-moz-full-screen iframe, .viewer:-ms-fullscreen iframe { width: 100vw; height: 100vh; object-fit: contain; }\n\n    /* Play overlay */\n    #startOverlay { position:absolute; inset:0; background:linear-gradient(135deg,#330066 0%, #1c0033 50%, #0d001a 100%); display:flex; flex-direction:column; justify-content:center; align-items:center; gap:1.5rem; z-index:10; transition:opacity .5s ease; }\n    .viewer:fullscreen #startOverlay, .viewer:-webkit-full-screen #startOverlay, .viewer:-moz-full-screen #startOverlay, .viewer:-ms-fullscreen #startOverlay { width: 100vw; height: 100vh; }\n    #startOverlay img { width:clamp(200px,40vw,350px); max-width:80%; border-radius:15px; box-shadow:0 10px 40px rgba(255, 102, 255, 0.4); border: 2px solid rgba(255, 102, 255, 0.3); }\n    #startOverlay h1 { margin:0; font-size:clamp(1.5rem,2.5vw,3rem); color:#fff; font-family:var(--font-main); text-shadow: 0 0 20px var(--accent); font-weight: 900; }\n    #startButton { padding:1rem 2.5rem; font-size:clamp(1rem,1.5vw,1.5rem); background:linear-gradient(135deg, var(--accent), var(--accent-dark)); color:#fff; border:none; border-radius:12px; cursor:pointer; transition:.3s; font-weight:900; font-family:var(--font-main); box-shadow:0 5px 25px rgba(255, 102, 255, 0.5); border: 2px solid rgba(255, 102, 255, 0.3); }\n    #startButton:hover { background:linear-gradient(135deg, var(--accent-light), var(--accent)); box-shadow:0 8px 35px rgba(255, 102, 255, 0.7); transform: translateY(-3px) scale(1.05); }\n    \n    /* Grid & cards */\n    .category { margin-top:3rem; max-width: var(--content-max-width); margin-left: auto; margin-right: auto; padding: 0 clamp(0.5rem, 2vw, 1rem); }\n    .category:first-of-type { margin-top: 1rem; }\n    .category h2 { color:#ffccff; margin-bottom:1rem; cursor:pointer; font-family:var(--font-main); font-weight: 900; font-size: clamp(1.3rem, 2vw, 2rem); text-shadow: 0 0 15px rgba(255, 102, 255, 0.5); padding-bottom: 0.5rem; border-bottom: 2px solid rgba(255, 102, 255, 0.3); }\n    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(clamp(140px, 18vw, 220px), 1fr)); gap: var(--grid-gap); justify-items:center; width: 100%; }\n    @media (min-width: 1400px) { .grid { grid-template-columns: repeat(6, 1fr); } }\n    @media (min-width: 1200px) and (max-width: 1399px) { .grid { grid-template-columns: repeat(5, 1fr); } }\n    @media (min-width: 900px) and (max-width: 1199px) { .grid { grid-template-columns: repeat(4, 1fr); } }\n    @media (min-width: 600px) and (max-width: 899px) { .grid { grid-template-columns: repeat(3, 1fr); } }\n    @media (min-width: 400px) and (max-width: 599px) { .grid { grid-template-columns: repeat(2, 1fr); } }\n    @media (max-width: 399px) { .grid { grid-template-columns: 1fr; } }\n\n    .card { width:100%; background: linear-gradient(135deg, var(--card-bg), #5a0077); border-radius:15px; overflow:hidden; cursor:pointer; transition: all .3s ease; text-align:center; display:flex; flex-direction:column; align-items:center; position:relative; border: 2px solid rgba(255, 102, 255, 0.2); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); -webkit-tap-highlight-color: transparent; touch-action: manipulation; }\n    .card:hover { transform:translateY(-5px) scale(1.03); background: linear-gradient(135deg, var(--card-hover), #7700aa); border: 2px solid var(--accent); box-shadow: 0 8px 30px rgba(255, 102, 255, 0.5); }\n\n    .thumb-container { width:100%; position:relative; overflow:hidden; border-radius:12px; background:#220033; display: flex; align-items: center; justify-content: center; aspect-ratio: 1 / 1; }\n    .thumb-container::before { content:""; position:absolute; inset:0; background-size:cover; background-position:center; filter: blur(20px) brightness(0.5); z-index:0; transition:transform .3s ease; background-image: var(--thumb-url); }\n    .card:hover .thumb-container::before { transform: scale(1.1); }\n    .thumb { position:relative; z-index:1; width:100%; height:100%; object-fit:cover; object-position: center; transition:transform .3s ease; }\n    .card:hover .thumb { transform:scale(1.08); }\n\n    .card-title { position: absolute; bottom: 0; left: 0; right: 0; margin: 0; padding: 0.6rem 0.5rem; font-family: var(--font-main); font-weight: 700; font-size: clamp(0.75rem, 0.9vw, 0.9rem); background: linear-gradient(to top, rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.4), transparent); color: #fff; opacity: 0; transform: translateY(10px); transition: all .3s ease; z-index: 2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n    .card:hover .card-title { opacity: 1; transform: translateY(0); }\n\n    .card.more { background: linear-gradient(135deg, rgba(102, 0, 153, 0.3), rgba(77, 0, 102, 0.3)); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; flex-direction: column; color: #ffccff; border: 2px dashed rgba(255, 102, 255, 0.4); width: 100%; aspect-ratio: 1 / 1; transition: all .3s ease; animation: pulse 2s ease-in-out infinite; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); cursor: pointer; }\n    @keyframes pulse { 0%, 100% { border-color: rgba(255, 102, 255, 0.4); box-shadow: 0 4px 15px rgba(255, 102, 255, 0.2); } 50% { border-color: rgba(255, 102, 255, 0.7); box-shadow: 0 4px 25px rgba(255, 102, 255, 0.4); } }\n    .card.more:hover { background: linear-gradient(135deg, rgba(102, 0, 153, 0.5), rgba(77, 0, 102, 0.5)); border: 2px dashed var(--accent); transform: translateY(-5px) scale(1.03); box-shadow: 0 8px 30px rgba(255, 102, 255, 0.6); animation: none; }\n    .card.more .dots { font-size: clamp(3rem, 5vw, 4rem); line-height: 1; font-weight: 900; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }\n    .card.more .label { font-size: clamp(0.9rem, 1.2vw, 1.1rem); opacity: 0.9; font-family: var(--font-main); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }\n\n    #dmcaLink { display: block; text-align: center; background: transparent; color: rgba(255, 255, 255, 0.4); padding: 2rem 1rem; font-size: 0.7rem; text-decoration: none; transition: .3s; font-family: var(--font-main); font-weight: 300; margin-top: 4rem; border-top: 1px solid rgba(255, 255, 255, 0.05); }\n    #dmcaLink:hover { color: rgba(255, 255, 255, 0.6); }\n  </style>\n</head>\n<body>\n  \n  <!-- Sidebar -->\n  <div id=\"sidebar\">\n    <div id=\"sidebarIndicator\"></div>\n    <header onclick=\"goToHome()\"><img src=\"assets/logo.png\" alt=\"Logo\"></header>\n    <div id=\"sidebarScroll\">\n      <ul id=\"categoryList\">\n        <li onclick=\"filterCategory('Home')\">Home</li>\n        ${finalSidebarCategories}\n      </ul>\n    </div>\n  </div>\n\n  <!-- Content -->\n  <div id=\"content\">\n    <!-- Top Header with Search -->\n    <div id=\"topHeader\">\n      <h1 onclick=\"goToHome()\">Chromebook Unlocked Games</h1>\n      <div id=\"searchContainer\">\n        <span id=\"searchIcon\">üîç</span>\n        <input type=\"text\" id=\"searchBar\" placeholder=\"Search games...\" oninput=\"searchGames(this.value)\">\n        <div id=\"searchDropdown\"></div>\n      </div>\n      <button id=\"bookmarkBtn\" onclick=\"bookmarkPage()\" title=\"Bookmark this page\">‚≠ê</button>\n    </div>\n\n    <div class=\"content-wrapper\">\n      <div id=\"controls\">\n        <button id=\"backBtn\" onclick=\"closeGame()\">‚Üê Back</button>\n        <span id=\"gameTitle\"></span>\n        <button id=\"fullscreenBtn\" onclick=\"toggleFullscreen()\">‚õ∂ Fullscreen</button>\n      </div>\n      \n      <div class=\"viewer\" id=\"viewer\">\n        <div id=\"startOverlay\">\n          <img id=\"startThumb\" src=\"\" alt=\"Game Thumbnail\">\n          <h1 id=\"startName\"></h1>\n          <button id=\"startButton\" onclick=\"startGame()\">‚ñ∂ Play</button>\n        </div>\n        <iframe id=\"gameFrame\" src=\"\"></iframe>\n      </div>\n\n      <!-- Recently Played -->\n      <div class=\"category\" data-category=\"Recently Played\" id=\"recentlyPlayedSection\" style=\"display:none;\">\n        <h2>Recently Played</h2>\n        <div class=\"grid\" id=\"recentlyPlayedGrid\"></div>\n      </div>\n\n      <!-- All Games -->\n      <div class=\"category all-games-section\" data-category=\"All Games\" style=\"display:none;\">\n        <h2>All Games</h2>\n        <div class=\"grid\">\n          ${games.map((g, i) => generateGameCard(g, i)).join('')}\n        </div>\n      </div>\n\n      <!-- All category sections (including games for home view) -->\n      ${Object.keys(categories).map(cat => {\n        const list = categories[cat];\n        return `<div class=\"category\" data-category=\"${cat}\">\n          <h2>${cat}</h2>\n          <div class=\"grid\">\n            ${list.map((g, i) => generateGameCard(g, i)).join('')}\n          </div>\n        </div>`;\n      }).join('')}  \n      \n      <a href=\"dmca.html\" id=\"dmcaLink\" target=\"_blank\">DMCA</a>\n    </div>\n  </div>\n\n  <script>\n    const MAX_RECENT = 25;\n    const offsets = {}; // offsets[category] = number of revealed rows - 1\n    let gameViewActive = false; // Track if game viewer is open\n    let currentViewMode = 'home'; // Track current view: 'home' or 'category'\n    let currentGameFolder = null;\n    \n    // Get all valid game folders\n    function getValidGameFolders() {\n      const folders = new Set();\n      document.querySelectorAll('.game-card[data-folder]').forEach(card => {\n        folders.add(card.getAttribute('data-folder'));\n      });\n      return folders;\n    }\n    \n    // Clean recently played - remove games that no longer exist\n    function cleanRecentlyPlayed() {\n      const validFolders = getValidGameFolders();\n      let list = [];\n      try {\n        list = JSON.parse(localStorage.getItem('recentlyPlayed') || '[]');\n      } catch(e) { list = []; }\n      \n      // Filter out games whose folders don't exist anymore\n      const cleaned = list.filter(game => validFolders.has(game.folder));\n      \n      // Only update if something was removed\n      if (cleaned.length !== list.length) {\n        localStorage.setItem('recentlyPlayed', JSON.stringify(cleaned));\n        return cleaned;\n      }\n      return list;\n    }\n    \n    // Validate game exists before showing\n    function gameExists(folder) {\n      const validFolders = getValidGameFolders();\n      return validFolders.has(folder);\n    }\n    \n    // Helper: get grid element for a category\n    function gridForCategory(cat) {\n      return Array.from(document.querySelectorAll('.category'))\n        .find(el => el.getAttribute('data-category') === cat)\n        ?.querySelector('.grid');\n    }\n    \n    // Helper: compute number of columns currently active for a grid\n    function getColumnCount(grid) {\n      if (!grid) return 1;\n      const style = window.getComputedStyle(grid);\n      const cols = style.gridTemplateColumns;\n      if (!cols) return 1;\n      return cols.split(' ').filter(Boolean).length;\n    }\n    \n    // Create a "more" element\n    function createMoreCard(cat) {\n      const more = document.createElement('div');\n      more.className = 'card more';\n      more.innerHTML = '<div class=\"dots\">‚ãØ</div><div class=\"label\">Show More</div>';\n      more.addEventListener('click', (e) => {\n        offsets[cat] = (offsets[cat] || 0) + 1;\n        updateCategoryView(cat);\n      });\n      return more;\n    }\n    \n    // Show/hide cards for a category grid based on offset and current columns\n    function updateCategoryView(cat) {\n      const grid = gridForCategory(cat);\n      if (!grid) return;\n      \n      // Remove any existing .card.more\n      const existingMore = grid.querySelector('.card.more');\n      if (existingMore) existingMore.remove();\n      \n      // Gather game-card elements\n      const cards = Array.from(grid.querySelectorAll('.game-card'));\n      const total = cards.length;\n      \n      // If game viewer is active OR viewing specific category, show all cards\n      if (gameViewActive || currentViewMode === 'category') {\n        cards.forEach(c => c.style.display = '');\n        return;\n      }\n      \n      const cols = getColumnCount(grid);\n      \n      // Number of rows currently revealed\n      const rowsRevealed = (offsets[cat] || 0) + 1;\n      const slots = rowsRevealed * cols;\n      \n      // Check if we need a "more" card (only on home page)\n      const showMore = total > slots && currentViewMode === 'home';\n      \n      // Number of actual game items to show\n      const showCount = showMore ? (slots - 1) : Math.min(total, slots);\n      \n      // Show/hide cards\n      cards.forEach((c, idx) => {\n        c.style.display = (idx < showCount) ? '' : 'none';\n      });\n      \n      // If we should show a More card, append it at the end\n      if (showMore) {\n        const moreCard = createMoreCard(cat);\n        grid.appendChild(moreCard);\n      }\n    }\n    \n    // Update all categories\n    function updateAllCategories() {\n      const cats = Array.from(document.querySelectorAll('.category')).map(c => c.getAttribute('data-category'));\n      cats.forEach(cat => {\n        if (offsets[cat] === undefined) offsets[cat] = 0;\n        \n        const grid = gridForCategory(cat);\n        if (!grid) return;\n        \n        const cards = Array.from(grid.querySelectorAll('.game-card'));\n        const total = cards.length;\n        const cols = getColumnCount(grid) || 1;\n        const maxRows = Math.ceil(total / cols);\n        const maxOffset = Math.max(0, maxRows - 1);\n        \n        if (offsets[cat] > maxOffset) offsets[cat] = maxOffset;\n        \n        updateCategoryView(cat);\n      });\n    }\n    \n    // Populate Recently Played grid\n    function loadRecentlyPlayed() {\n      const list = cleanRecentlyPlayed(); // Clean before loading\n      \n      const recentSection = document.getElementById('recentlyPlayedSection');\n      const recentGrid = document.getElementById('recentlyPlayedGrid');\n      if (!recentGrid) return;\n      recentGrid.innerHTML = '';\n      \n      if (!list.length) {\n        if (recentSection) recentSection.style.display = 'none';\n        return;\n      }\n      \n      if (recentSection) {\n        recentSection.style.display = 'block';\n      }\n      \n      const displayList = list.slice(0, MAX_RECENT);\n      \n      // Double-check each game exists before displaying\n      displayList.forEach((g, i) => {\n        if (!gameExists(g.folder)) { return; }\n        const card = document.createElement('div');\n        card.className = 'card game-card';\n        card.setAttribute('data-index', i);\n        card.setAttribute('data-folder', g.folder);\n        card.setAttribute('data-name', g.name.toLowerCase());\n        const thumbUrl = g.thumb || 'assets/logo.png';\n        card.onclick = () => {\n          if (!gameExists(g.folder)) { cleanRecentlyPlayed(); loadRecentlyPlayed(); return; }\n          prepareGame(encodeURIComponent(g.folder), encodeURIComponent(g.name), thumbUrl);\n        };\n        card.innerHTML = `<div class=\"thumb-container\" style=\"--thumb-url: url('${thumbUrl}')\">\n          <img class=\"thumb\" src=\"${thumbUrl}\" alt=\"${g.name}\" onerror=\"this.src='assets/logo.png'\"> \n        </div>\n        <div class=\"card-title\">${g.name}</div>`;\n        recentGrid.appendChild(card);\n      }); \n      \n      if (offsets['Recently Played'] === undefined) offsets['Recently Played'] = 0;\n      updateCategoryView('Recently Played');\n      \n      // If grid is empty after cleanup, hide section\n      if (recentGrid.children.length === 0) {\n        recentSection.style.display = 'none';\n      }\n    }\n    \n    // Search functionality with dropdown\n    function searchGames(query) {\n      const searchTerm = query.toLowerCase().trim();\n      const searchDropdown = document.getElementById('searchDropdown');\n      \n      if (!searchTerm) {\n        // Hide dropdown when search is empty\n        searchDropdown.classList.remove('show');\n        searchDropdown.innerHTML = '';\n        return;\n      }\n      \n      // Collect all matching games\n      const matchingGames = [];\n      const seenFolders = new Set();\n      \n      document.querySelectorAll('.game-card[data-folder]').forEach(card => {\n        const gameName = card.getAttribute('data-name') || '';\n        const gameFolder = card.getAttribute('data-folder');\n        const gameTitle = card.querySelector('.card-title')?.textContent || '';\n        const thumbImg = card.querySelector('.thumb');\n        const thumbSrc = thumbImg ? thumbImg.src : '';\n        \n        if (gameName.includes(searchTerm) && !seenFolders.has(gameFolder)) {\n          seenFolders.add(gameFolder);\n          matchingGames.push({ folder: gameFolder, name: gameTitle, thumb: thumbSrc });\n        }\n      });\n      \n      // Sort by relevance (exact, then starts-with, then contains)\n      matchingGames.sort((a, b) => {\n        const aName = a.name.toLowerCase();\n        const bName = b.name.toLowerCase();\n        if (aName === searchTerm) return -1;\n        if (bName === searchTerm) return 1;\n        if (aName.startsWith(searchTerm) && !bName.startsWith(searchTerm)) return -1;\n        if (!aName.startsWith(searchTerm) && bName.startsWith(searchTerm)) return 1;\n        return aName.localeCompare(bName);\n      });\n      \n      const topResults = matchingGames.slice(0, 8);\n      \n      if (topResults.length === 0) {\n        searchDropdown.innerHTML = '<div class=\"search-no-results\">No games found</div>';\n      } else {\n        searchDropdown.innerHTML = topResults.map(game => {\n          const f = encodeURIComponent(game.folder);\n          const n = encodeURIComponent(game.name);\n          const t = game.thumb || 'assets/logo.png';\n          return `<button type=\"button\" class=\"search-result-item\" onclick=\"prepareGame('${f}','${n}','${t}'); hideSearchDropdown();\">\n                    <img class=\"search-result-thumb\" src=\"${t}\" alt=\"\">\n                    <div class=\"search-result-name\">${game.name}</div>\n                  </button>`;\n        }).join('');\n      }\n      \n      searchDropdown.classList.add('show');\n    }\n    \n    function hideSearchDropdown() {\n      const searchDropdown = document.getElementById('searchDropdown');\n      const searchBar = document.getElementById('searchBar');\n      searchDropdown.classList.remove('show');\n      searchBar.value = '';\n    }\n    \n    // Close dropdown when clicking outside\n    document.addEventListener('click', (e) => {\n      const searchContainer = document.getElementById('searchContainer');\n      const searchDropdown = document.getElementById('searchDropdown');\n      if (searchContainer && !searchContainer.contains(e.target)) {\n        searchDropdown.classList.remove('show');\n      }\n    });\n    \n    // Bookmark page function\n    function bookmarkPage() {\n      const pageTitle = document.title;\n      const pageUrl = window.location.href;\n      \n      if (window.sidebar && window.sidebar.addPanel) {  \n        window.sidebar.addPanel(pageTitle, pageUrl, "");\n      } else if (window.external && ('AddFavorite' in window.external)) {  \n        window.external.AddFavorite(pageUrl, pageTitle);\n      } else if (window.opera && window.print) {  \n        return true;\n      } else {  \n        const isMac = navigator.userAgent.toLowerCase().indexOf('mac') !== -1;\n        const key = isMac ? 'Cmd' : 'Ctrl';\n        alert(`Press ${key} + D to bookmark this page.`);\n      }\n    }\n    // Navigate to home page\n    function goToHome() {\n      window.location.hash = '';\n      const searchBar = document.getElementById('searchBar');\n      if (searchBar) searchBar.value = '';\n      hideSearchDropdown();\n      closeGame();\n      filterCategory('Home');\n    }\n    const viewer = document.getElementById('viewer');\n    const frame = document.getElementById('gameFrame');\n    const controls = document.getElementById('controls');\n    const gameTitle = document.getElementById('gameTitle');\n    const startOverlay = document.getElementById('startOverlay');\n    const startThumb = document.getElementById('startThumb');\n    const startName = document.getElementById('startName');\n    \n    function prepareGame(folderEncoded, nameEncoded, thumbSrc) {\n      const folder = decodeURIComponent(folderEncoded);\n      const name = decodeURIComponent(nameEncoded);\n      \n      if (!gameExists(folder)) {\n        cleanRecentlyPlayed();\n        loadRecentlyPlayed();\n        return;\n      }\n      \n      currentGameFolder = folder;\n      frame.src = '';\n      viewer.style.display = 'flex';\n      controls.classList.add('active');\n      gameTitle.textContent = name;\n      startThumb.src = thumbSrc || 'assets/logo.png';\n      startThumb.onerror = () => { startThumb.src = 'assets/logo.png'; };\n      startName.textContent = name;\n      startOverlay.style.opacity = '1';\n      startOverlay.style.pointerEvents = 'auto';\n      window.location.hash = '#/game/' + folderEncoded;\n      document.getElementById('content').scrollTop = 0;\n      \n      gameViewActive = true;\n      \n      const recentlyPlayedSection = document.getElementById('recentlyPlayedSection');\n      if (recentlyPlayedSection) {\n        recentlyPlayedSection.style.display = 'none';\n        recentlyPlayedSection.style.visibility = 'hidden';\n      }\n      \n      document.querySelectorAll('.category').forEach(cat => {\n        if (cat.id !== 'curatedGamesSection') {\n          cat.style.display = 'none';\n        }\n      });\n      \n      showCuratedGames(folder);\n      saveRecentlyPlayed({ folder, name, thumb: thumbSrc || 'assets/logo.png' });\n    }\n    \n    function showCuratedGames(currentGameFolder) {\n      const searchResults = document.getElementById('searchResultsSection');\n      if (searchResults) searchResults.style.display = 'none';\n      const recentSection = document.getElementById('recentlyPlayedSection');\n      if (recentSection) {\n        recentSection.style.display = 'none';\n        recentSection.style.visibility = 'hidden';\n        recentSection.style.position = 'absolute';\n        recentSection.style.top = '-9999px';\n      }\n      \n      let currentCategory = null;\n      const categorySections = document.querySelectorAll('.category');\n      categorySections.forEach(cat => {\n        const catName = cat.getAttribute('data-category');\n        if (catName === 'Recently Played' || cat.id === 'recentlyPlayedSection' || cat.id === 'searchResultsSection' || cat.id === 'curatedGamesSection') return;\n        const gameCards = cat.querySelectorAll('.game-card[data-folder]');\n        gameCards.forEach(card => {\n          if (card.getAttribute('data-folder') === currentGameFolder) {\n            currentCategory = catName;\n          }\n        });\n      });\n      \n      const allGames = [];\n      const sameCategory = [];\n      const seenFolders = new Set();\n      seenFolders.add(currentGameFolder);\n      categorySections.forEach(cat => {\n        const catName = cat.getAttribute('data-category');\n        if (catName === 'Recently Played' || cat.id === 'recentlyPlayedSection' || cat.id === 'searchResultsSection' || cat.id === 'curatedGamesSection') return;\n        const gameCards = cat.querySelectorAll('.game-card[data-folder]');\n        gameCards.forEach(card => {\n          const folder = card.getAttribute('data-folder');\n          if (seenFolders.has(folder)) return;\n          seenFolders.add(folder);\n          const clonedCard = card.cloneNode(true);\n          clonedCard.style.display = '';\n          clonedCard.style.visibility = 'visible';\n          const gameData = { card: clonedCard, folder: folder, category: catName };\n          allGames.push(gameData);\n          if (catName === currentCategory) sameCategory.push(gameData);\n        });\n      });\n      if (allGames.length === 0) return;\n      \n      const shuffleArray = (array) => {\n        const arr = [...array];\n        for (let i = arr.length - 1; i > 0; i--) {\n          const j = Math.floor(Math.random() * (i + 1));\n          [arr[i], arr[j]] = [arr[j], arr[i]];\n        }\n        return arr;\n      };\n      \n      let curatedSection = document.getElementById('curatedGamesSection');\n      if (!curatedSection) {\n        curatedSection = document.createElement('div');\n        curatedSection.id = 'curatedGamesSection';\n        curatedSection.className = 'category';\n        curatedSection.innerHTML = '<h2>You May Like</h2><div class=\"grid\" id=\"curatedGamesGrid\"></div>';\n        const viewer = document.querySelector('.viewer');\n        if (viewer.nextSibling) {\n          viewer.parentNode.insertBefore(curatedSection, viewer.nextSibling);\n        } else {\n          viewer.parentNode.appendChild(curatedSection);\n        }\n      }\n      curatedSection.style.display = 'block';\n      const curatedGrid = document.getElementById('curatedGamesGrid');\n      curatedGrid.innerHTML = '';\n      \n      const cols = getColumnCount(curatedGrid) || 1;\n      const targetRows = 7; // always 7 rows regardless of resolution\n      const targetCount = cols * targetRows;\n      \n      const shuffledSameCategory = shuffleArray(sameCategory);\n      const shuffledAllGames = shuffleArray(allGames);\n      \n      const curatedGames = [];\n      if (sameCategory.length === 0) {\n        curatedGames.push(...shuffledAllGames.slice(0, Math.min(targetCount, shuffledAllGames.length)));\n      } else {\n        const sameCatTarget = Math.min(Math.ceil(targetCount * 0.6), sameCategory.length);\n        curatedGames.push(...shuffledSameCategory.slice(0, sameCatTarget));\n        const usedFolders = new Set(curatedGames.map(g => g.folder));\n        const otherGames = shuffledAllGames.filter(g => !usedFolders.has(g.folder));\n        const remainingSlots = Math.max(0, targetCount - curatedGames.length);\n        curatedGames.push(...otherGames.slice(0, remainingSlots));\n      }\n      \n      const finalCurated = shuffleArray(curatedGames).slice(0, targetCount);\n      finalCurated.forEach(game => curatedGrid.appendChild(game.card));\n    }\n    \n    function startGame() {\n      if (!currentGameFolder) return;\n      frame.src = 'games/' + currentGameFolder + '/index.html';\n      startOverlay.style.opacity = '0';\n      startOverlay.style.pointerEvents = 'none';\n    }\n    function closeGame() {\n      frame.src = '';\n      viewer.style.display = 'none';\n      controls.classList.remove('active');\n      gameTitle.textContent = '';\n      currentGameFolder = null;\n      startOverlay.style.opacity = '1';\n      startOverlay.style.pointerEvents = 'auto';\n      window.location.hash = '';\n      \n      gameViewActive = false;\n      \n      const curatedSection = document.getElementById('curatedGamesSection');\n      if (curatedSection) curatedSection.style.display = 'none';\n      \n      const searchResults = document.getElementById('searchResultsSection');\n      if (searchResults) searchResults.style.display = 'none';\n      \n      const recentlyPlayedSection = document.getElementById('recentlyPlayedSection');\n      if (recentlyPlayedSection) {\n        const recentGrid = document.getElementById('recentlyPlayedGrid');\n        if (recentGrid && recentGrid.children.length > 0) {\n          recentlyPlayedSection.style.display = 'block';\n          recentlyPlayedSection.style.visibility = 'visible';\n          recentlyPlayedSection.style.position = 'relative';\n          recentlyPlayedSection.style.top = 'auto';\n        }\n      }\n      \n      document.querySelectorAll('.category').forEach(cat => {\n        const category = cat.getAttribute('data-category');\n        if (category === 'Recently Played') {\n          const recentGrid = document.getElementById('recentlyPlayedGrid');\n          cat.style.display = (recentGrid && recentGrid.children.length > 0) ? 'block' : 'none';\n        } else if (cat.id !== 'curatedGamesSection' && cat.id !== 'searchResultsSection') {\n          cat.style.display = 'block';\n        }\n      });\n      \n      updateAllCategories();\n    }\n    \n    function toggleFullscreen() {\n      const viewerElement = document.querySelector('.viewer');\n      if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {\n        if (viewerElement.requestFullscreen) { viewerElement.requestFullscreen(); }\n        else if (viewerElement.webkitRequestFullscreen) { viewerElement.webkitRequestFullscreen(); }\n        else if (viewerElement.mozRequestFullScreen) { viewerElement.mozRequestFullScreen(); }\n        else if (viewerElement.msRequestFullscreen) { viewerElement.msRequestFullscreen(); }\n      } else {\n        if (document.exitFullscreen) { document.exitFullscreen(); }\n        else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }\n        else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); }\n        else if (document.msExitFullscreen) { document.msExitFullscreen(); }\n      }\n    }\n    document.addEventListener('fullscreenchange', ()=>{});\n    document.addEventListener('webkitfullscreenchange', ()=>{});\n    document.addEventListener('mozfullscreenchange', ()=>{});\n    document.addEventListener('MSFullscreenChange', ()=>{});\n    \n    function saveRecentlyPlayed(game) {\n      let list = cleanRecentlyPlayed();\n      list = list.filter(g => g.folder !== game.folder);\n      list.unshift(game);\n      if (list.length > MAX_RECENT) list = list.slice(0, MAX_RECENT);\n      localStorage.setItem('recentlyPlayed', JSON.stringify(list));\n      loadRecentlyPlayed();\n    }\n    \n    function filterCategory(cat) {\n      const all = document.querySelectorAll('.category');\n      const searchBar = document.getElementById('searchBar');\n      \n      if (gameViewActive) { closeGame(); }\n      if (searchBar) searchBar.value = '';\n      hideSearchDropdown();\n      \n      const searchResults = document.getElementById('searchResultsSection');\n      if (searchResults) searchResults.style.display = 'none';\n      const curatedSection = document.getElementById('curatedGamesSection');\n      if (curatedSection) curatedSection.style.display = 'none';\n      \n      if (cat === 'Home') {\n        currentViewMode = 'home';\n        all.forEach(c => {\n          const category = c.getAttribute('data-category');\n          if (c.id === 'searchResultsSection' || c.id === 'curatedGamesSection') return;\n          if (category === 'Recently Played') {\n            const recentGrid = document.getElementById('recentlyPlayedGrid');\n            c.style.display = (recentGrid && recentGrid.children.length > 0) ? 'block' : 'none';\n          } else {\n            c.style.display = 'block';\n          }\n        });\n      } else {\n        currentViewMode = 'category';\n        all.forEach(c => {\n          const category = c.getAttribute('data-category');\n          if (c.id === 'searchResultsSection' || c.id === 'curatedGamesSection') return;\n          c.style.display = (category === cat) ? 'block' : 'none';\n        });\n      }\n      \n      document.getElementById('content').scrollTop = 0;\n      updateAllCategories();\n    }\n    \n    function handleRouting() {\n      const hash = window.location.hash;\n      if (hash.startsWith('#/game/')) {\n        const folder = decodeURIComponent(hash.replace('#/game/', ''));\n        if (!gameExists(folder)) {\n          window.location.hash = '';\n          return;\n        }\n        const cards = Array.from(document.querySelectorAll('.game-card'));\n        const card = cards.find(c => c.getAttribute('onclick')?.includes(encodeURIComponent(folder)));\n        if (card) card.click();\n      } else {\n        closeGame();\n        filterCategory('Home');\n      }\n    }\n    \n    let resizeTimeout = null;\n    window.addEventListener('resize', () => {\n      clearTimeout(resizeTimeout);\n      resizeTimeout = setTimeout(() => {\n        updateAllCategories();\n        if (gameViewActive && currentGameFolder) {\n          showCuratedGames(currentGameFolder);\n        }\n      }, 120);\n    });\n    \n    document.addEventListener('DOMContentLoaded', () => {\n      document.querySelectorAll('.category').forEach(c => {\n        const cat = c.getAttribute('data-category');\n        if (offsets[cat] === undefined) offsets[cat] = 0;\n      });\n      \n      document.querySelectorAll('.thumb-container').forEach(tc => {\n        const img = tc.querySelector('img.thumb');\n        if (img && (!tc.style.getPropertyValue('--thumb-url') || tc.style.getPropertyValue('--thumb-url') === '')) {\n          tc.style.setProperty('--thumb-url', "url('" + img.src + "')");\n        }\n      });\n      \n      document.querySelectorAll('img.thumb').forEach(img => {\n        img.onerror = function() {\n          this.onerror = null; // Prevent infinite loop\n          this.src = 'assets/logo.png';\n          const container = this.closest('.thumb-container');\n          if (container) { container.style.setProperty('--thumb-url', "url('assets/logo.png')"); }\n        };\n      });\n      \n      loadRecentlyPlayed();\n      updateAllCategories();\n      handleRouting();\n      window.addEventListener('hashchange', handleRouting);\n    });\n  </script>\n</body>\n</html>`;\n\n// Write output\nfs.writeFileSync(outputFile, html);\nconsole.log("‚úÖ Build complete: index.html generated");